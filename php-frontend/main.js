const makeWASocket = require("@whiskeysockets/baileys").default;
const { useMultiFileAuthState } = require("@whiskeysockets/baileys");
const qrcode = require("qrcode");
const express = require("express");
const { createServer } = require("http");
const { Server } = require("socket.io");
const path = require("path");
const fs = require("fs");
const mysql = require("mysql2");
const portfinder = require("portfinder"); // Adicionado para verificar a porta

const app = express();
const server = createServer(app);
const io = new Server(server, {
    cors: {
        origin: "*", // Permite todas as origens (ajuste para produ√ß√£o)
    },
});

// Configura√ß√£o do servidor de arquivos est√°ticos
app.use(express.static(path.join(__dirname, "public")));

// Rota principal
app.get("/", (req, res) => {
    res.redirect("http://localhost/php-frontend2/index.php");
});

// Objeto para armazenar o estado da conversa de cada usu√°rio
const usuarios = {};

// Estado da conex√£o
let sock = null;
let qrCodeData = null;

// Configura√ß√£o da conex√£o com o banco de dados
const connection = mysql.createConnection({
    host: "localhost",
    user: "root",
    password: "",
    database: "db_senai",
});

// Fun√ß√£o para salvar os dados no banco de dados
function salvarAtendimento(numero, escolha, email, opcaoAtendimento, statusAtendimento = 'Aberto') {
    const query = `
        INSERT INTO atendimentos (numero, escolha, email, opcao_atendimento, status_atendimento)
        VALUES (?, ?, ?, ?, ?)
    `;
    connection.query(query, [numero, escolha, email, opcaoAtendimento, statusAtendimento], (err, results) => {
        if (err) {
            console.error("Erro ao salvar atendimento:", err);
        } else {
            console.log("Atendimento salvo com sucesso!");
            usuarios[numero].atendimentoId = results.insertId;
        }
    });
}

// Fun√ß√£o para atualizar o status do atendimento
function atualizarStatusAtendimento(atendimentoId, statusAtendimento) {
    const query = `
        UPDATE atendimentos
        SET status_atendimento = ?
        WHERE id = ?
    `;
    connection.query(query, [statusAtendimento, atendimentoId], (err, results) => {
        if (err) {
            console.error("Erro ao atualizar status do atendimento:", err);
        } else {
            console.log("Status do atendimento atualizado com sucesso!");
        }
    });
}

// Fun√ß√£o para apagar a pasta auth_info
function apagarAuthInfo() {
    const authInfoPath = path.join(__dirname, "auth_info");
    if (fs.existsSync(authInfoPath)) {
        fs.rmSync(authInfoPath, { recursive: true, force: true });
        console.log("Pasta auth_info apagada com sucesso.");
    }
}

// Fun√ß√£o para desconectar o bot
function desconectarBot() {
    if (sock) {
        sock.end();
        sock = null;
    }
    apagarAuthInfo();
    io.emit("disconnected");
}

// Fun√ß√£o para iniciar a conex√£o com o WhatsApp
async function iniciarBot() {
    try {
        const authDir = path.join(__dirname, "auth_info");

        if (!fs.existsSync(authDir)) {
            fs.mkdirSync(authDir, { recursive: true });
            console.log("Diret√≥rio auth_info criado.");
        }

        if (process.platform !== "win32") {
            fs.chmodSync(authDir, 0o777);
            console.log("Permiss√µes do diret√≥rio auth_info definidas.");
        }

        const { state, saveCreds } = await useMultiFileAuthState(authDir);
        console.log("Estado de autentica√ß√£o carregado:", state);

        sock = makeWASocket({
            auth: state,
            printQRInTerminal: false,
        });

        sock.ev.on("connection.update", async (update) => {
            const { qr, connection, lastDisconnect } = update;

            if (qr) {
                console.log("QR Code gerado.");
                qrCodeData = await qrcode.toDataURL(qr);
                io.emit("qrCode", qrCodeData);
            }

            if (connection === "open") {
                console.log("Conex√£o estabelecida com sucesso.");
                io.emit("connected", true);
            }

            if (connection === "close") {
                console.log("Conex√£o fechada. Motivo:", lastDisconnect?.error?.output?.statusCode);
                const shouldReconnect = lastDisconnect?.error?.output?.statusCode !== 401;
                if (shouldReconnect) {
                    console.log("Reconectando em 10 segundos...");
                    setTimeout(iniciarBot, 10000);
                } else {
                    console.log("Conex√£o fechada. Por favor, escaneie o QR Code novamente.");
                    io.emit("qrCode", null);
                }
            }
        });

        sock.ev.on("creds.update", saveCreds);

        sock.ev.on("messages.upsert", async ({ messages }) => {
            for (const mensagem of messages) {
                if (!mensagem.key.fromMe && mensagem.message?.conversation) {
                    const texto = mensagem.message.conversation.toLowerCase();
                    const remetente = mensagem.key.remoteJid;

                    console.log(`üì© Mensagem recebida de ${remetente}: ${texto}`);
                    await gerenciarFluxoConversa(sock, remetente, texto);
                }
            }
        });
    } catch (error) {
        console.error("Erro ao iniciar o bot:", error);
        io.emit("error", "Erro ao conectar. Tente novamente.");
        apagarAuthInfo();
        setTimeout(iniciarBot, 10000);
    }
}

// Fun√ß√£o para gerenciar o fluxo de conversa
async function gerenciarFluxoConversa(sock, remetente, texto) {
    if (!usuarios[remetente]) {
        usuarios[remetente] = { passo: 1 };
    }

    const usuario = usuarios[remetente];

    switch (usuario.passo) {
        case 1:
            await sock.sendMessage(remetente, {
                text: "Ol√°! Bem-vindo ao atendimento do SENAI. Como posso ajudar?",
            });
            await sock.sendMessage(remetente, {
                text: "Por favor nos informe para qual dos itens abaixo voc√™ deseja atendimento:\n\n1- Sesi\n2- Senai",
            });
            usuario.passo = 2;
            break;

        case 2:
            if (texto === "1" || texto === "2") {
                usuario.escolha = texto === "1" ? "Sesi" : "Senai";
                await sock.sendMessage(remetente, {
                    text: "Voc√™ concorda com os nossos Termos de Uso e Pol√≠tica de Privacidade? Acesse aqui: https://www.sp.senai.br/termos-de-uso-e-politica-de-privacidade' \n\n1- Sim\n2- N√£o  ",
                });
                usuario.passo = 3;
            } else {
                await sock.sendMessage(remetente, {
                    text: "Op√ß√£o inv√°lida. Por favor, digite 1 para Sesi ou 2 para Senai.",
                });
            }
            break;

        case 3:
            if (texto === "1" || texto === "2") {
                usuario.aceitouTermos = texto === "1";
                if (usuario.aceitouTermos) {
                    await sock.sendMessage(remetente, {
                        text: "Para iniciar seu atendimento, preciso do seu email. Por favor, digite seu email.",
                    });
                    usuario.passo = 4;
                } else {
                    await sock.sendMessage(remetente, {
                        text: "Infelizmente, n√£o podemos continuar sem sua aceita√ß√£o dos Termos de Uso e Pol√≠tica de Privacidade.",
                    });
                    delete usuarios[remetente];
                }
            } else {
                await sock.sendMessage(remetente, {
                    text: "Op√ß√£o inv√°lida. Por favor, digite 1 para Sim ou 2 para N√£o.",
                });
            }
            break;

        case 4:
            if (texto.includes("@")) {
                usuario.email = texto;
                await sock.sendMessage(remetente, {
                    text: "Sobre qual assunto voc√™ deseja atendimento?\n\n1- Curso Presencial e EAD\n2- Atendimento a Empresas\n3- Emiss√£o de Boleto - SENAI\n4- Documenta√ß√£o/Certificado\n5- RH / Licita√ß√µes / Arrecada√ß√£o / Outras √°reas",
                });
                usuario.passo = 5;
            } else {
                await sock.sendMessage(remetente, {
                    text: "Email inv√°lido. Por favor, digite um email v√°lido.",
                });
            }
            break;

        case 5:
            if (["1", "2", "3", "4", "5"].includes(texto)) {
                usuario.opcaoAtendimento = texto;
                salvarAtendimento(
                    remetente,
                    usuario.escolha,
                    usuario.email,
                    usuario.opcaoAtendimento,
                    'Aberto'
                );
                switch (usuario.opcaoAtendimento) {
                    case "1":
                        await sock.sendMessage(remetente, {
                            text: "Voc√™ perguntou sobre Cursos. Como posso te ajudar?\n\n1- Cursos de Curta Dura√ß√£o (Presencial)\n2- Cursos de Curta Dura√ß√£o a Dist√¢ncia (EAD)\n3- Cursos de Curta Dura√ß√£o (Bolsa de Estudos)\n4- Curso Regular (Aprendizagem Industrial)\n5- Curso Regular (T√©cnico)\n6- Curso Regular (Faculdade)\n7- Curso Regular (P√≥s Gradua√ß√£o)",
                        });
                        usuario.passo = 6;
                        break;
                    case "2":
                        await sock.sendMessage(remetente, {
                            text: "Voc√™ perguntou sobre Atendimento √†s Empresas. Como posso te ajudar?\n\n1- Servi√ßos Laboratoriais\n2- Assessoria\n3- Inova√ß√£o\n4- Contrata√ß√£o de Alunos",
                        });
                        usuario.passo = 7;
                        break;
                    case "3":
                        await sock.sendMessage(remetente, {
                            text: "Para emiss√£o de boleto, entre em contato conosco pelo site: https://www.senai.br/ou pelo telefone (XX) XXXX-XXXX.",
                        });
                        usuario.passo = 8;
                        break;
                    case "4":
                        await sock.sendMessage(remetente, {
                            text: "Para documenta√ß√£o/certificado, entre em contato conosco pelo site: https://www.senai.br/ou pelo telefone (XX) XXXX-XXXX.",
                        });
                        usuario.passo = 8;
                        break;
                    case "5":
                        await sock.sendMessage(remetente, {
                            text: "Para RH / Licita√ß√µes / Arrecada√ß√£o / Outras √°reas, entre em contato conosco pelo site: https://www.senai.br/ou pelo telefone (XX) XXXX-XXXX.",
                        });
                        usuario.passo = 8;
                        break;
                    default:
                        await sock.sendMessage(remetente, {
                            text: "Op√ß√£o inv√°lida. Por favor, digite o n√∫mero da op√ß√£o desejada.",
                        });
                        break;
                }
            } else {
                await sock.sendMessage(remetente, {
                    text: "Op√ß√£o inv√°lida. Por favor, digite o n√∫mero da op√ß√£o desejada.",
                });
            }
            break;

        case 6:
            if (["1", "2", "3", "4", "5", "6", "7"].includes(texto)) {
                await sock.sendMessage(remetente, {
                    text: "Antes de concluirmos, suas d√∫vidas foram esclarecidas?\n\n1- Sim\n2- N√£o",
                });
                usuario.passo = 8;
            } else {
                await sock.sendMessage(remetente, {
                    text: "Op√ß√£o inv√°lida. Por favor, digite o n√∫mero da op√ß√£o desejada.",
                });
            }
            break;

        case 7:
            if (["1", "2", "3", "4"].includes(texto)) {
                await sock.sendMessage(remetente, {
                    text: "Antes de concluirmos, suas d√∫vidas foram esclarecidas?\n\n1- Sim\n2- N√£o",
                });
                usuario.passo = 8;
            } else {
                await sock.sendMessage(remetente, {
                    text: "Op√ß√£o inv√°lida. Por favor, digite o n√∫mero da op√ß√£o desejada.",
                });
            }
            break;

        case 8:
            if (texto === "1" || texto === "2") {
                if (texto === "1") {
                    await sock.sendMessage(remetente, {
                        text: "Que bom que suas d√∫vidas foram esclarecidas! Obrigado por entrar em contato.",
                    });
                    if (usuario.atendimentoId) {
                        atualizarStatusAtendimento(usuario.atendimentoId, 'Finalizado');
                    }
                    delete usuarios[remetente];
                } else {
                    await sock.sendMessage(remetente, {
                        text: "Podemos recome√ßar o atendimento por aqui ou voc√™ pode enviar seu questionamento por escrito para ser respondido por um atendente. O que voc√™ prefere?\n\n1- Responder formul√°rio\n2- Retornar ao menu\n3- Falar com Atendente",
                    });
                    usuario.passo = 9;
                }
            } else {
                await sock.sendMessage(remetente, {
                    text: "Op√ß√£o inv√°lida. Por favor, digite 1 para Sim ou 2 para N√£o.",
                });
            }
            break;

        case 9:
            if (["1", "2", "3"].includes(texto)) {
                switch (texto) {
                    case "1":
                        await sock.sendMessage(remetente, {
                            text: "Por favor, acesse o formul√°rio em: https://www.senai.br/formulario",
                        });
                        break;
                    case "2":
                        await sock.sendMessage(remetente, {
                            text: "Retornando ao menu principal...",
                        });
                        usuario.passo = 1;
                        break;
                    case "3":
                        await sock.sendMessage(remetente, {
                            text: "Por favor, entre em contato conosco pelo telefone (XX) XXXX-XXXX.",
                        });
                        break;
                }
                if (texto !== "2" && usuario.atendimentoId) {
                    atualizarStatusAtendimento(usuario.atendimentoId, 'Finalizado');
                }
                if (texto !== "2") {
                    delete usuarios[remetente];
                }
            } else {
                await sock.sendMessage(remetente, {
                    text: "Op√ß√£o inv√°lida. Por favor, digite o n√∫mero da op√ß√£o desejada.",
                });
            }
            break;

        default:
            await sock.sendMessage(remetente, {
                text: "Ocorreu um erro no fluxo de atendimento. Por favor, tente novamente.",
            });
            delete usuarios[remetente];
            break;
    }
}

// Inicia a conex√£o quando o cliente clica no bot√£o
io.on("connection", (socket) => {
    console.log("Cliente conectado ao Socket.IO");

    socket.on("iniciarConexao", () => {
        iniciarBot();
    });

    socket.on("desconectarBot", () => {
        desconectarBot();
    });
});

// Verifica se a porta est√° em uso antes de iniciar o servidor
const PORT = 5000;
portfinder.getPort({ port: PORT }, (err, port) => {
    if (err) {
        console.error("Erro ao verificar a porta:", err);
        return;
    }

    if (port !== PORT) {
        console.log(`Porta ${PORT} j√° est√° em uso. O servidor n√£o ser√° iniciado.`);
        return;
    }

    // Inicia o servidor se a porta estiver livre
    server.listen(PORT, () => {
        console.log(`Servidor rodando em http://localhost:${PORT}`);
    });
});